#!/bin/bash
# Pre-commit hook to prevent committing secrets

echo "üîí Checking for secrets..."

# Patterns that indicate HARDCODED secrets (not env var references)
# We exclude Deno.env.get(), process.env, and import.meta.env patterns
PATTERNS=(
    'sk_live_[a-zA-Z0-9]+'                   # Stripe live keys (actual values)
    'sk_test_[a-zA-Z0-9]+'                   # Stripe test keys (actual values)
    'AKIA[0-9A-Z]{16}'                       # AWS Access Keys
    'service_role.*eyJ'                      # Hardcoded service role JWT
)

# Files to check (staged files) - exclude Edge Functions that legitimately reference env vars
FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|json|md|sh|env)$')

if [ -z "$FILES" ]; then
    echo "‚úÖ No relevant files to check"
    exit 0
fi

FOUND_SECRETS=0

for pattern in "${PATTERNS[@]}"; do
    # Exclude files that use Deno.env.get or process.env (legitimate env var access)
    MATCHES=$(echo "$FILES" | xargs grep -l -E "$pattern" 2>/dev/null | grep -v '.env.example' | grep -v 'node_modules' | grep -v 'supabase/functions')
    if [ -n "$MATCHES" ]; then
        echo "‚ùå Potential secret found matching pattern: $pattern"
        echo "   In files: $MATCHES"
        FOUND_SECRETS=1
    fi
done

# Check for .env files being committed
ENV_FILES=$(git diff --cached --name-only | grep -E '^\.env$|^env/\.env$|\.env\.local$|\.env\.production$')
if [ -n "$ENV_FILES" ]; then
    echo "‚ùå Attempting to commit environment files: $ENV_FILES"
    FOUND_SECRETS=1
fi

if [ $FOUND_SECRETS -eq 1 ]; then
    echo ""
    echo "üö´ COMMIT BLOCKED: Potential secrets detected!"
    echo "   Please remove secrets and use environment variables instead."
    echo "   If this is a false positive, use: git commit --no-verify"
    exit 1
fi

echo "‚úÖ No secrets detected"
exit 0
