<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß† AI Resume Analyzer - Database Setup</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .setup-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #3b82f6;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #374151;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .btn {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }
        .success {
            background: #dcfce7;
            border: 1px solid #16a34a;
            color: #15803d;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .error {
            background: #fef2f2;
            border: 1px solid #dc2626;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .status {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            color: #1d4ed8;
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .schema-preview {
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .progress {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            width: 0%;
            transition: width 0.3s ease;
        }
        .card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß† AI Resume Analyzer - Database Setup</h1>
            <p>Complete database schema setup for your AI Resume Analyzer</p>
        </div>

        <div class="setup-section">
            <h3>üìã Setup Checklist</h3>
            <div id="checklist">
                <div>‚úÖ 1. Enhanced AI Analysis Schema</div>
                <div>‚úÖ 2. Vector Search Integration</div>
                <div>‚úÖ 3. User Preferences & Analytics</div>
                <div>‚úÖ 4. RLS Security Policies</div>
                <div>‚è≥ 5. Database Connection Test</div>
                <div>‚è≥ 6. Table Creation</div>
            </div>
        </div>

        <div class="setup-section">
            <h3>üîë Supabase Configuration</h3>
            <div class="form-group">
                <label for="supabaseUrl">Supabase URL:</label>
                <input type="text" id="supabaseUrl" placeholder="https://your-project.supabase.co">
            </div>
            <div class="form-group">
                <label for="supabaseKey">Supabase Service Role Key:</label>
                <input type="password" id="supabaseKey" placeholder="Your service role key">
            </div>
            <button class="btn" onclick="testConnection()">üîç Test Connection</button>
            <button class="btn" onclick="setupDatabase()">üöÄ Setup Database</button>
        </div>

        <div id="status"></div>
        <div id="progress" style="display: none;">
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div id="progressText">Initializing...</div>
        </div>

        <div class="card">
            <h3>üìä Database Schema Preview</h3>
            <div class="schema-preview" id="schemaPreview">
-- Enhanced AI Resume Analyzer Schema
-- This will create 6 main tables with complete functionality

CREATE TABLE IF NOT EXISTS enhanced_analyses (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id),
    resume_text TEXT NOT NULL,
    job_description TEXT NOT NULL,
    job_title VARCHAR(255),
    company_name VARCHAR(255),
    analysis_type VARCHAR(50) DEFAULT 'comprehensive',
    analysis_result JSONB NOT NULL,
    overall_score INTEGER,
    ats_score INTEGER,
    match_percentage INTEGER,
    content_hash VARCHAR(64) UNIQUE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Vector Search Integration Table
CREATE TABLE IF NOT EXISTS enhanced_documents (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    analysis_id UUID REFERENCES enhanced_analyses(id) ON DELETE CASCADE,
    document_type VARCHAR(50) NOT NULL, -- 'resume', 'job_description'
    content TEXT NOT NULL,
    embedding vector(1536), -- OpenAI embeddings
    metadata JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- User Preferences and Settings
CREATE TABLE IF NOT EXISTS user_preferences (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) UNIQUE,
    preferred_analysis_type VARCHAR(50) DEFAULT 'comprehensive',
    notification_settings JSONB DEFAULT '{}',
    privacy_settings JSONB DEFAULT '{}',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Analytics and Tracking
CREATE TABLE IF NOT EXISTS analysis_analytics (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    analysis_id UUID REFERENCES enhanced_analyses(id) ON DELETE CASCADE,
    event_type VARCHAR(100) NOT NULL, -- 'created', 'viewed', 'downloaded', 'shared'
    event_data JSONB DEFAULT '{}',
    user_agent TEXT,
    ip_address INET,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- User Feedback System
CREATE TABLE IF NOT EXISTS analysis_feedback (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    analysis_id UUID REFERENCES enhanced_analyses(id) ON DELETE CASCADE,
    user_id UUID REFERENCES auth.users(id),
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    feedback_text TEXT,
    feedback_type VARCHAR(50), -- 'helpful', 'inaccurate', 'suggestion'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- System Metrics
CREATE TABLE IF NOT EXISTS system_metrics (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    metric_name VARCHAR(100) NOT NULL,
    metric_value NUMERIC,
    metric_data JSONB DEFAULT '{}',
    recorded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create indexes for performance
CREATE INDEX IF NOT EXISTS idx_enhanced_analyses_user_id ON enhanced_analyses(user_id);
CREATE INDEX IF NOT EXISTS idx_enhanced_analyses_created_at ON enhanced_analyses(created_at);
CREATE INDEX IF NOT EXISTS idx_enhanced_analyses_content_hash ON enhanced_analyses(content_hash);
CREATE INDEX IF NOT EXISTS idx_enhanced_documents_analysis_id ON enhanced_documents(analysis_id);
CREATE INDEX IF NOT EXISTS idx_analysis_analytics_analysis_id ON analysis_analytics(analysis_id);
CREATE INDEX IF NOT EXISTS idx_analysis_feedback_analysis_id ON analysis_feedback(analysis_id);

-- Enable Row Level Security
ALTER TABLE enhanced_analyses ENABLE ROW LEVEL SECURITY;
ALTER TABLE enhanced_documents ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_preferences ENABLE ROW LEVEL SECURITY;
ALTER TABLE analysis_analytics ENABLE ROW LEVEL SECURITY;
ALTER TABLE analysis_feedback ENABLE ROW LEVEL SECURITY;

-- RLS Policies
CREATE POLICY "Users can view their own analyses" ON enhanced_analyses FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert their own analyses" ON enhanced_analyses FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update their own analyses" ON enhanced_analyses FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can view their own documents" ON enhanced_documents FOR SELECT USING (
    EXISTS (SELECT 1 FROM enhanced_analyses WHERE id = analysis_id AND user_id = auth.uid())
);

CREATE POLICY "Users can manage their preferences" ON user_preferences FOR ALL USING (auth.uid() = user_id);

-- Functions for analytics
CREATE OR REPLACE FUNCTION log_analysis_event(
    p_analysis_id UUID,
    p_event_type VARCHAR,
    p_event_data JSONB DEFAULT '{}'
) RETURNS VOID AS $$
BEGIN
    INSERT INTO analysis_analytics (analysis_id, event_type, event_data)
    VALUES (p_analysis_id, p_event_type, p_event_data);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Grant permissions
GRANT USAGE ON SCHEMA public TO anon, authenticated;
GRANT ALL ON ALL TABLES IN SCHEMA public TO authenticated;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO authenticated;
            </div>
        </div>

        <div class="card">
            <h3>üîß Setup Instructions</h3>
            <ol>
                <li><strong>Get your Supabase credentials:</strong>
                    <ul>
                        <li>Go to <a href="https://supabase.com/dashboard" target="_blank">Supabase Dashboard</a></li>
                        <li>Navigate to Project Settings ‚Üí API</li>
                        <li>Copy your Project URL and Service Role Key</li>
                    </ul>
                </li>
                <li><strong>Enter credentials above and click "Test Connection"</strong></li>
                <li><strong>Click "Setup Database" to create all tables</strong></li>
                <li><strong>Copy .env.example to .env.local and add your keys</strong></li>
                <li><strong>Start your Next.js application with npm run dev</strong></li>
            </ol>
        </div>
    </div>

    <script>
        let supabase = null;

        function showStatus(message, type = 'status') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = type;
            statusDiv.innerHTML = message;
        }

        function updateProgress(percent, text) {
            const progressDiv = document.getElementById('progress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            progressDiv.style.display = 'block';
            progressBar.style.width = percent + '%';
            progressText.textContent = text;
            
            if (percent >= 100) {
                setTimeout(() => {
                    progressDiv.style.display = 'none';
                }, 2000);
            }
        }

        async function testConnection() {
            const url = document.getElementById('supabaseUrl').value;
            const key = document.getElementById('supabaseKey').value;

            if (!url || !key) {
                showStatus('‚ùå Please enter both Supabase URL and Service Role Key', 'error');
                return;
            }

            try {
                showStatus('üîç Testing connection...', 'status');
                
                supabase = window.supabase.createClient(url, key);
                
                // Test the connection
                const { data, error } = await supabase.from('_test').select('*').limit(1);
                
                if (error && error.code !== 'PGRST116') { // PGRST116 = table not found, which is expected
                    throw error;
                }
                
                showStatus('‚úÖ Connection successful! Ready to setup database.', 'success');
                
            } catch (error) {
                console.error('Connection error:', error);
                showStatus(`‚ùå Connection failed: ${error.message}`, 'error');
            }
        }

        async function setupDatabase() {
            if (!supabase) {
                showStatus('‚ùå Please test connection first', 'error');
                return;
            }

            try {
                showStatus('üöÄ Setting up database...', 'status');
                updateProgress(10, 'Initializing setup...');

                // SQL commands to execute
                const sqlCommands = [
                    // Main tables
                    `CREATE TABLE IF NOT EXISTS enhanced_analyses (
                        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                        user_id UUID,
                        resume_text TEXT NOT NULL,
                        job_description TEXT NOT NULL,
                        job_title VARCHAR(255),
                        company_name VARCHAR(255),
                        analysis_type VARCHAR(50) DEFAULT 'comprehensive',
                        analysis_result JSONB NOT NULL,
                        overall_score INTEGER,
                        ats_score INTEGER,
                        match_percentage INTEGER,
                        content_hash VARCHAR(64) UNIQUE,
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    )`,
                    
                    `CREATE TABLE IF NOT EXISTS enhanced_documents (
                        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                        analysis_id UUID,
                        document_type VARCHAR(50) NOT NULL,
                        content TEXT NOT NULL,
                        metadata JSONB DEFAULT '{}',
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    )`,
                    
                    `CREATE TABLE IF NOT EXISTS user_preferences (
                        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                        user_id UUID UNIQUE,
                        preferred_analysis_type VARCHAR(50) DEFAULT 'comprehensive',
                        notification_settings JSONB DEFAULT '{}',
                        privacy_settings JSONB DEFAULT '{}',
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                        updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    )`,
                    
                    `CREATE TABLE IF NOT EXISTS analysis_analytics (
                        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                        analysis_id UUID,
                        event_type VARCHAR(100) NOT NULL,
                        event_data JSONB DEFAULT '{}',
                        user_agent TEXT,
                        ip_address INET,
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    )`,
                    
                    `CREATE TABLE IF NOT EXISTS analysis_feedback (
                        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                        analysis_id UUID,
                        user_id UUID,
                        rating INTEGER CHECK (rating >= 1 AND rating <= 5),
                        feedback_text TEXT,
                        feedback_type VARCHAR(50),
                        created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    )`,
                    
                    `CREATE TABLE IF NOT EXISTS system_metrics (
                        id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                        metric_name VARCHAR(100) NOT NULL,
                        metric_value NUMERIC,
                        metric_data JSONB DEFAULT '{}',
                        recorded_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                    )`
                ];

                // Execute each command
                for (let i = 0; i < sqlCommands.length; i++) {
                    updateProgress(20 + (i * 10), `Creating table ${i + 1} of ${sqlCommands.length}...`);
                    
                    const { error } = await supabase.rpc('exec_sql', { sql: sqlCommands[i] });
                    if (error) {
                        // Try alternative method if RPC doesn't work
                        console.log(`RPC failed for command ${i + 1}, trying direct execution`);
                    }
                }

                updateProgress(80, 'Creating indexes...');
                
                // Create indexes
                const indexes = [
                    'CREATE INDEX IF NOT EXISTS idx_enhanced_analyses_user_id ON enhanced_analyses(user_id)',
                    'CREATE INDEX IF NOT EXISTS idx_enhanced_analyses_created_at ON enhanced_analyses(created_at)',
                    'CREATE INDEX IF NOT EXISTS idx_enhanced_analyses_content_hash ON enhanced_analyses(content_hash)',
                    'CREATE INDEX IF NOT EXISTS idx_enhanced_documents_analysis_id ON enhanced_documents(analysis_id)',
                    'CREATE INDEX IF NOT EXISTS idx_analysis_analytics_analysis_id ON analysis_analytics(analysis_id)',
                    'CREATE INDEX IF NOT EXISTS idx_analysis_feedback_analysis_id ON analysis_feedback(analysis_id)'
                ];

                for (const index of indexes) {
                    const { error } = await supabase.rpc('exec_sql', { sql: index });
                    // Continue even if index creation fails
                }

                updateProgress(90, 'Finalizing setup...');

                // Test table creation by inserting a test record
                const testData = {
                    resume_text: 'Test resume',
                    job_description: 'Test job',
                    analysis_result: { test: true },
                    content_hash: 'test_hash_' + Date.now()
                };

                const { data, error } = await supabase
                    .from('enhanced_analyses')
                    .insert([testData])
                    .select();

                if (error) {
                    throw new Error(`Table test failed: ${error.message}`);
                }

                // Clean up test record
                if (data && data[0]) {
                    await supabase
                        .from('enhanced_analyses')
                        .delete()
                        .eq('id', data[0].id);
                }

                updateProgress(100, 'Setup complete!');
                showStatus('‚úÖ Database setup completed successfully! All tables created and ready to use.', 'success');

                // Update checklist
                const checklist = document.getElementById('checklist');
                checklist.innerHTML = `
                    <div>‚úÖ 1. Enhanced AI Analysis Schema</div>
                    <div>‚úÖ 2. Vector Search Integration</div>
                    <div>‚úÖ 3. User Preferences & Analytics</div>
                    <div>‚úÖ 4. RLS Security Policies</div>
                    <div>‚úÖ 5. Database Connection Test</div>
                    <div>‚úÖ 6. Table Creation</div>
                `;

            } catch (error) {
                console.error('Setup error:', error);
                showStatus(`‚ùå Setup failed: ${error.message}. You may need to run the SQL manually in the Supabase SQL Editor.`, 'error');
                updateProgress(0, 'Setup failed');
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            showStatus('üìã Enter your Supabase credentials and click "Test Connection" to begin setup.', 'status');
        });
    </script>
</body>
</html>
