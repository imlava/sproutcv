<!DOCTYPE html>
<html>
<head>
    <title>üî• Final Diagnostic Test</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .success { background: #e8f5e8; border-left: 4px solid #4caf50; }
        .warning { background: #fff3e0; border-left: 4px solid #ff9800; }
        pre { white-space: pre-wrap; word-wrap: break-word; font-size: 12px; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
        .status { font-weight: bold; margin: 10px 0; font-size: 18px; }
        .step { margin: 5px 0; padding: 5px; border-left: 3px solid #ddd; }
        .step.success { border-color: #4caf50; }
        .step.error { border-color: #f44336; }
    </style>
</head>
<body>
    <h1>üî• Final Payment Diagnostic Test</h1>
    
    <div class="status" id="status">Ready to diagnose payment issues</div>
    
    <div style="margin: 20px 0;">
        <button onclick="runFullDiagnostic()">üîç Run Full Diagnostic</button>
        <button onclick="testMinimalPayment()">üß™ Test Minimal Payment</button>
        <button onclick="testPaymentDiagnostic()">üîß Test Payment Diagnostic</button>
        <button onclick="clearResults()">üßπ Clear Results</button>
    </div>
    
    <div id="results"></div>

    <script>
        const supabaseUrl = 'https://yucdpvnmcuokemhqpnvz.supabase.co';
        const supabaseKey = '***REMOVED***';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Set the session from previous test
        const sessionData = {
            "access_token": "eyJhbGciOiJIUzI1NiIsImtpZCI6ImhubGtRcURmeVhMekJ4RUYiLCJ0eXAiOiJKV1QifQ.eyJpc3MiOiJodHRwczovL3l1Y2Rwdm5tY3Vva2VtaHFwbnZ6LnN1cGFiYXNlLmNvL2F1dGgvdjEiLCJzdWIiOiI1NmVjZDI0MC01N2JkLTQxOTYtODQ0OS1mOGI1ZDM2MGNhYzUiLCJhdWQiOiJhdXRoZW50aWNhdGVkIiwiZXhwIjoxNzU2NzUzODEyLCJpYXQiOjE3NTY3NTAyMTIsImVtYWlsIjoiaGV5QGltbGF2YS5pbiIsInBob25lIjoiIiwiYXBwX21ldGFkYXRhIjp7InByb3ZpZGVyIjoiZW1haWwiLCJwcm92aWRlcnMiOlsiZW1haWwiXX0sInVzZXJfbWV0YWRhdGEiOnsiZW1haWwiOiJoZXlAaW1sYXZhLmluIiwiZW1haWxfdmVyaWZpZWQiOnRydWUsImZ1bGxfbmFtZSI6ImxhdmEiLCJwaG9uZV92ZXJpZmllZCI6ZmFsc2UsInN1YiI6IjU2ZWNkMjQwLTU3YmQtNDE5Ni04NDQ5LWY4YjVkMzYwY2FjNSJ9LCJyb2xlIjoiYXV0aGVudGljYXRlZCIsImFhbCI6ImFhbDEiLCJhbXIiOlt7Im1ldGhvZCI6InBhc3N3b3JkIiwidGltZXN0YW1wIjoxNzU2NzUwMjEyfV0sInNlc3Npb25faWQiOiI1ODcxNjdmNS1lMjRlLTQ1NWQtYTM4ZS1jOTBiMmY1NWQyODgiLCJpc19hbm9ueW1vdXMiOmZhbHNlfQ.5fCQfJ63frEcyA9rYv6vaJvUFgeABv6_7eyWAGC29uc",
            "refresh_token": "x5c4uaccmcwu"
        };

        // Set session on page load
        window.onload = async () => {
            try {
                await supabase.auth.setSession(sessionData);
                updateStatus("Session set automatically", false);
            } catch (error) {
                updateStatus("Failed to set session: " + error.message, true);
            }
        };

        function updateStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.color = isError ? '#f44336' : '#4caf50';
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            updateStatus('Results cleared');
        }

        async function runFullDiagnostic() {
            updateStatus('Running full diagnostic...');
            
            const results = [];
            
            // Test 1: Session check
            results.push(await testSessionStatus());
            
            // Test 2: Payment diagnostic
            results.push(await runPaymentDiagnostic());
            
            // Test 3: Minimal payment
            results.push(await runMinimalPayment());
            
            // Test 4: Try different Edge Functions
            results.push(await testFunction('nuclear-debug', {}));
            results.push(await testFunction('ultra-simple-test', {}));
            
            displayResults('üîç Full Diagnostic Results', results);
            updateStatus('Full diagnostic completed');
        }

        async function testSessionStatus() {
            try {
                const { data: sessionData, error } = await supabase.auth.getSession();
                
                if (error) throw error;
                
                if (!sessionData.session) {
                    return {
                        test: 'Session Status',
                        status: 'error',
                        message: 'No active session'
                    };
                }
                
                const token = sessionData.session.access_token;
                const payload = JSON.parse(atob(token.split('.')[1]));
                
                return {
                    test: 'Session Status',
                    status: 'success',
                    message: 'Valid user session',
                    data: {
                        userId: payload.sub,
                        email: payload.email,
                        role: payload.role,
                        expires: new Date(payload.exp * 1000).toLocaleString()
                    }
                };
            } catch (error) {
                return {
                    test: 'Session Status',
                    status: 'error',
                    message: error.message
                };
            }
        }

        async function runPaymentDiagnostic() {
            return await testFunction('payment-diagnostic', {
                credits: 5,
                amount: 500,
                planType: 'starter'
            });
        }

        async function runMinimalPayment() {
            return await testFunction('payment-minimal', {
                credits: 5,
                amount: 500,
                planType: 'starter'
            });
        }

        async function testPaymentDiagnostic() {
            updateStatus('Testing payment diagnostic...');
            const result = await runPaymentDiagnostic();
            displayResults('üîß Payment Diagnostic', [result]);
        }

        async function testMinimalPayment() {
            updateStatus('Testing minimal payment...');
            const result = await runMinimalPayment();
            displayResults('üß™ Minimal Payment Test', [result]);
        }

        async function testFunction(functionName, body) {
            try {
                console.log(`Testing function: ${functionName}`);
                
                const { data, error } = await supabase.functions.invoke(functionName, { body });
                
                if (error) {
                    return {
                        test: functionName,
                        status: 'error',
                        message: `Function error: ${error.message}`,
                        error: error
                    };
                }
                
                return {
                    test: functionName,
                    status: 'success',
                    message: 'Function executed successfully',
                    data: data
                };
                
            } catch (error) {
                return {
                    test: functionName,
                    status: 'error',
                    message: `Exception: ${error.message}`,
                    error: error
                };
            }
        }

        function displayResults(title, results) {
            const resultsDiv = document.getElementById('results');
            
            let html = `<h3>${title}</h3>`;
            
            results.forEach(result => {
                const statusClass = result.status === 'success' ? 'success' : 'error';
                html += `
                    <div class="step ${statusClass}">
                        <strong>${result.test}:</strong> ${result.message}
                        ${result.data ? `<pre>${JSON.stringify(result.data, null, 2)}</pre>` : ''}
                        ${result.error ? `<pre>Error: ${JSON.stringify(result.error, null, 2)}</pre>` : ''}
                    </div>
                `;
            });
            
            resultsDiv.innerHTML += `<div class="result">${html}</div>`;
        }
    </script>
</body>
</html>
