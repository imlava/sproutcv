<!DOCTYPE html>
<html>
<head>
    <title>üî• SproutCV Auth Fix Test</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .success { background: #e8f5e8; border-left: 4px solid #4caf50; }
        .warning { background: #fff3e0; border-left: 4px solid #ff9800; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
        button { padding: 10px 20px; margin: 10px 5px; cursor: pointer; }
        .status { font-weight: bold; margin: 10px 0; }
        input { padding: 8px; margin: 5px; width: 250px; }
        .section { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>üî• SproutCV Authentication Fix Test</h1>
    
    <div class="status" id="status">Ready to fix authentication</div>
    
    <div class="section">
        <h3>üîì Step 1: Sign In</h3>
        <input type="email" id="email" placeholder="Email" value="hey@imlava.in">
        <input type="password" id="password" placeholder="Password">
        <button onclick="signIn()">Sign In</button>
        <button onclick="signOut()">Sign Out</button>
    </div>
    
    <div class="section">
        <h3>üîç Step 2: Check Authentication</h3>
        <button onclick="checkAuth()">Check Auth Status</button>
        <button onclick="testPaymentFixed()">Test Fixed Payment</button>
    </div>
    
    <div id="authResult"></div>
    <div id="paymentResult"></div>

    <script>
        const supabaseUrl = 'https://yucdpvnmcuokemhqpnvz.supabase.co';
        const supabaseKey = '***REMOVED***';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function updateStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.color = isError ? '#f44336' : '#4caf50';
        }

        async function signIn() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                updateStatus('Please enter email and password', true);
                return;
            }
            
            updateStatus('Signing in...');
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    throw error;
                }
                
                updateStatus('Sign in successful!');
                document.getElementById('authResult').innerHTML = `
                    <div class="result success">
                        <strong>‚úÖ Sign In Successful</strong><br>
                        <strong>User ID:</strong> ${data.user.id}<br>
                        <strong>Email:</strong> ${data.user.email}<br>
                        <strong>Session:</strong> Active<br>
                    </div>
                `;
                
                // Auto-check auth after sign in
                setTimeout(checkAuth, 1000);
                
            } catch (error) {
                console.error('Sign in error:', error);
                updateStatus('Sign in failed: ' + error.message, true);
                document.getElementById('authResult').innerHTML = `
                    <div class="result error">
                        <strong>‚ùå Sign In Failed</strong><br>
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function signOut() {
            updateStatus('Signing out...');
            
            try {
                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    throw error;
                }
                
                updateStatus('Signed out successfully');
                document.getElementById('authResult').innerHTML = `
                    <div class="result warning">
                        <strong>‚ö†Ô∏è Signed Out</strong><br>
                        No active session
                    </div>
                `;
                
            } catch (error) {
                console.error('Sign out error:', error);
                updateStatus('Sign out failed: ' + error.message, true);
            }
        }

        async function checkAuth() {
            updateStatus('Checking authentication...');
            
            try {
                const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    throw sessionError;
                }
                
                let authHtml = '<h3>üîç Authentication Analysis:</h3>';
                
                if (!sessionData.session) {
                    authHtml += `<div class="result error">
                        <strong>‚ùå No Active Session</strong><br>
                        Please sign in first to test payment functions.
                    </div>`;
                    updateStatus('No active session - please sign in first', true);
                } else {
                    const session = sessionData.session;
                    const token = session.access_token;
                    
                    // Decode JWT for detailed analysis
                    let jwtInfo = {};
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        jwtInfo = {
                            userId: payload.sub,
                            email: payload.email,
                            role: payload.role,
                            issuer: payload.iss,
                            expiry: new Date(payload.exp * 1000).toLocaleString(),
                            issuedAt: new Date(payload.iat * 1000).toLocaleString(),
                            isExpired: payload.exp < (Date.now() / 1000),
                            hasUserData: !!payload.sub && payload.role === 'authenticated'
                        };
                    } catch (e) {
                        jwtInfo.error = 'Failed to decode JWT: ' + e.message;
                    }
                    
                    const isValidUserToken = jwtInfo.hasUserData && !jwtInfo.isExpired;
                    
                    authHtml += `<div class="result ${isValidUserToken ? 'success' : 'error'}">
                        <strong>${isValidUserToken ? '‚úÖ' : '‚ùå'} Authentication Status</strong><br>
                        <strong>User ID:</strong> ${session.user.id}<br>
                        <strong>Email:</strong> ${session.user.email}<br>
                        <strong>Token Type:</strong> ${jwtInfo.role === 'authenticated' ? 'User Session' : 'Anonymous'}<br>
                        <strong>Token Valid:</strong> ${isValidUserToken ? 'YES' : 'NO'}<br>
                        <strong>Has User Claims:</strong> ${jwtInfo.hasUserData ? 'YES' : 'NO'}<br>
                        <strong>Is Expired:</strong> ${jwtInfo.isExpired ? 'YES' : 'NO'}<br>
                        <br>
                        <strong>JWT Payload:</strong><br>
                        <pre>${JSON.stringify(jwtInfo, null, 2)}</pre>
                    </div>`;
                    
                    if (isValidUserToken) {
                        updateStatus('Authentication valid - ready to test payment!');
                    } else {
                        updateStatus('Invalid authentication token detected', true);
                    }
                }
                
                document.getElementById('authResult').innerHTML = authHtml;
                
            } catch (error) {
                console.error('Auth check error:', error);
                updateStatus('Auth check failed: ' + error.message, true);
                document.getElementById('authResult').innerHTML = `
                    <div class="result error">
                        <strong>‚ùå Auth Check Failed</strong><br>
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        async function testPaymentFixed() {
            updateStatus('Testing payment with fixed authentication...');
            
            try {
                // First verify we have a valid session
                const { data: sessionData } = await supabase.auth.getSession();
                
                if (!sessionData.session) {
                    throw new Error('No active session - please sign in first');
                }
                
                // Verify token is a user token, not anon token
                const token = sessionData.session.access_token;
                const payload = JSON.parse(atob(token.split('.')[1]));
                
                if (payload.role !== 'authenticated' || !payload.sub) {
                    throw new Error('Invalid token type - not a user session token');
                }
                
                console.log('Using valid user token:', {
                    userId: payload.sub,
                    role: payload.role,
                    email: payload.email
                });
                
                // Now test the bulletproof payment function
                const { data, error } = await supabase.functions.invoke('create-payment-bulletproof', {
                    body: { 
                        credits: 5,
                        amount: 500,
                        planType: 'starter',
                        test_mode: true 
                    }
                });
                
                console.log('Payment test result:', { data, error });
                
                let paymentHtml = '<h3>üí≥ Fixed Payment Test:</h3>';
                
                if (error) {
                    paymentHtml += `<div class="result error">
                        <strong>‚ùå Payment Function Error</strong><br>
                        <strong>Error:</strong> ${error.message}<br>
                        <strong>Full Error:</strong><br>
                        <pre>${JSON.stringify(error, null, 2)}</pre>
                    </div>`;
                    updateStatus('Payment test failed!', true);
                } else {
                    paymentHtml += `<div class="result success">
                        <strong>‚úÖ Payment Function SUCCESS!</strong><br>
                        <strong>Payment ID:</strong> ${data.paymentId || 'N/A'}<br>
                        <strong>Amount:</strong> $${(data.amount / 100).toFixed(2)}<br>
                        <strong>Credits:</strong> ${data.credits}<br>
                        <strong>Auth Method:</strong> ${data.authMethod}<br>
                        <strong>Version:</strong> ${data.version}<br>
                        <br>
                        <strong>Payment URL:</strong> <a href="${data.url}" target="_blank">Open Payment</a><br>
                        <br>
                        <strong>Full Response:</strong><br>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>`;
                    updateStatus('üéâ PAYMENT TEST SUCCESSFUL! Issue is FIXED!');
                }
                
                document.getElementById('paymentResult').innerHTML = paymentHtml;
                
            } catch (error) {
                console.error('Payment test error:', error);
                updateStatus('Payment test failed: ' + error.message, true);
                document.getElementById('paymentResult').innerHTML = `
                    <div class="result error">
                        <strong>‚ùå Payment Test Exception</strong><br>
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            }
        }

        // Auto-check auth on load
        window.onload = () => {
            checkAuth();
        };
    </script>
</body>
</html>
